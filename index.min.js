// @koala-append "./assets/js/local/variables.js"

// @koala-append "./assets/js/local/arduino.js"

// @koala-append "./assets/js/local/functions.js"

// @koala-append "./assets/js/local/port.js"

// @koala-append "./assets/js/local/socket.js"




var express = require('express'); //This thing makes sending a starting html page to the user easy
var http = require('http');
var app = express();
var server = http.createServer(app);
var fs = require('fs');
/*Facny collors*/
var colors = require('colors');


//LDS Stuff
var counter = 0;
var LDSScanData = [];

//this is for setldsrotation to toggle on and off with the button
var toggled = 0;
var DistInMM;

//this is for the angles and distances that is printed
var thingToSend = [];

//this is for  = LDSScanData.length;
var l;

//This is for my graph
var pos = [];
var posX;
var posY;
var PI_180 = (Math.PI/180);

//SENDING STUFF TO WEBSITE
var io = require('socket.io').listen(server);	//This makes sending and recieving data from the server easy
var persistantSocket;
app.use(express.static(__dirname + '/html'));	//Just tells the thing to use the current directory as the root page... I think
app.get('/', function(req, res){
    res.sendfile('./index.html');			//This is how you get it to send something to the browser
});

//Initial value of lowest dist and angle
var lowestDist  = 123 + 237;
var lowestAngle = 360;
var angle       = 360;
//Used to reset values of lowest dist and angle
var maxDist  = lowestDist;
var maxAngle = angle;

//bumper data timing stuff
var slTime = 0;
var flTime = 0;
var srTime = 0;
var frTime = 0;
var fl = 0;
var sl = 0;
var sr = 0;
var fr = 0;

//read LDSStream from Robot
var SerialPort = require("serialport");
/*serial port information*/
var port = new SerialPort("COM3", {
    baudRate: 115200,
    /*parser: SerialPort.parsers.raw*/
    parser: SerialPort.parsers.readline("\n")
});

var temp = new Array();


/*arduino board*/

//ardino board stuff
var five = require("johnny-five"),
    board = new five.Board({
        port: "COM5",
        repl: false,
        debug: false,
    });

//LED STrip
pixel = require("node-pixel");
var strip = null;

// Create an Led
var ledSL;
var ledFL;
var ledFR;
var ledSR;
var fps = 20;
board.on("ready", function() {
    //Bumper LEDS
    console.log('Board Ready!!!'.white);
    // Side left pin on pin 8
    ledSL = new five.Led(8);
    // front left pin on pin 9
    ledFL = new five.Led(9);
    // Side right pin on pin 10
    ledFR = new five.Led(10);
    // front right pin on pin 11
    ledSR = new five.Led(11);
    //IDk why this needs to be here
    ledSL.off();
    ledFL.off();
    ledFR.off();
    ledSR.off();

    // Define our led light strip
    // It's a 40px ring connected to pin 6.
    strip = new pixel.Strip({
        board: this,
        controller: "FIRMATA",
        strips: [ {pin: 6, length: 40}, ],
        gamma: 2.8,
    });

    // Just like DOM-ready for web developers.
    strip.on("ready", function() {

        console.log("Strip ready, let's go");

    });
});
function greenRun( delay){
    console.log('Strip I wrote!!!'.white);
    // Set the entire strip to pink.
    strip.color('#903');

    // Set first and seventh pixels to turquoise.
    strip.pixel(0).color('#074');
    strip.pixel(10).color('#074');
    strip.pixel(20).color('#074');
    strip.pixel(30).color('#074');

    // Display initial state.
    strip.show();

    // Loop the following command forever
    // at set FPS until Arduino powers down.
    setInterval(function () {
        // Shift all pixels clockwise
        strip.shift(1, pixel.FORWARD, true);
        strip.show();
    }, 1000 / delay );
}

function dynamicRainbow( delay ){
    console.log( 'dynamicRainbow' );

    var showColor;
    var cwi = 0; // colour wheel index (current position on colour wheel)
    setInterval(function(){
        if (++cwi > 255) {
            cwi = 0;
        }

        for(var i = 0; i < strip.length; i++) {
            showColor = colorWheel( ( cwi+i ) & 255 );
            strip.pixel( i ).color( showColor );
        }
        strip.show();
    }, 1000/delay);
}

// Input a value 0 to 255 to get a color value.
// The colors are a transition r - g - b - back to r.
function colorWheel( WheelPos ){
    var r,g,b;
    WheelPos = 255 - WheelPos;

    if ( WheelPos < 85 ) {
        r = 255 - WheelPos * 3;
        g = 0;
        b = WheelPos * 3;
    } else if (WheelPos < 170) {
        WheelPos -= 85;
        r = 0;
        g = WheelPos * 3;
        b = 255 - WheelPos * 3;
    } else {
        WheelPos -= 170;
        r = WheelPos * 3;
        g = 255 - WheelPos * 3;
        b = 0;
    }
    // returns a string with the rgb value to be used as the parameter
    return "rgb(" + r +"," + g + "," + b + ")";
}
/*End arduino board*/
setTimeout(function(){
    console.log("gimme a sec");
}, 3000);

// sleep time expects milliseconds
function sleep (time) {
  return new Promise((resolve) => setTimeout(resolve, time));
}

// Usage!
sleep(500).then(() => {
    console.log("slept");
});

function bumperLight(){

    if(sl != 0){
        console.log("Side Left On");
        ledSL.on();
    } else if(sl == 0){
        ledSL.off();
    }

    /*if fl != 0 then it is being triggered*/
    if(fl != 0){
        console.log("Front Left On");
        ledFL.on();
    } else if(fl == 0){
        ledFL.off();
    }

    if(fr != 0){
        console.log("Front Right On");
        ledFR.on();
    } else if(fr == 0){
        ledFR.off();
    }

    if(sr != 0){
        console.log("Side Right On");
        ledSR.on();
    } else if(sr == 0){
        ledSR.off();
    }
    console.log("-----------------------------------".white);
}

module.exports = {

    getLDSScan: function(){
        //get new LDS scan data
        port.write('getldsscan', function(err) {
            if (err) {
                return console.log('Error on write: ', err.message);
            }
        });
        //send enter key
        port.write('\r', function(err) {
            if (err) {
                return console.log('Error on write: ', err.message);
            }
        });
    },

    setLDSRotation: function(){
        //check this fucntion
        greenRun(fps);
        if (toggled == 0){
            //write to the robot and turn on LDSrotation
            port.write('setldsrotation on', function(err) {
                if (err) {return console.log('Error on write: ', err.message);}
            });
            toggled++;
        } else {
            //write to the robot and turn off LDSrotation
            port.write('setldsrotation off', function(err) {
                if (err) {return console.log('Error on write: ', err.message);}
            });
            toggled--;
        }

        //send enter key
        port.write('\r', function(err) {
            if (err) {return console.log('Error on write: ', err.message);}
        });
    },
    /*Gets distance and angles from LDS data to trigger bumpers*/
    getDistanceAndAngles: function(LDSScanData,maxDist,angle,l,lowestDist){
        var tmp;

        /*theres like 360 things inside of LDSScanData*/
        while (l--) {
            tmp = LDSScanData[l].DistInMM;
            angle = LDSScanData[l].AngleInDegrees;

            /*Left front bumper*/
            if (angle > 0 && angle <= 38){
                fl++;
            } else if( angle > 38 && angle <= 50 ){
                /*Side left bumper*/
                sl++;
            } else if(angle >= 330 && angle < 360){
                /*right front bumper*/
                fr++;
            } else if(angle >= 314 && angle < 330){
                /*right side bumper*/
                sr++;
            }
        }

        /*Some message to say if something is there*/
        if (fl != 0 || sl != 0 || sr !=0 || fr !=0){
            thingToSend += "<h1>Something's out there</h1>";
        } else{
            thingToSend += "<h1>Nothing</h1>";
        }

        /*turns on leds if any of the vlues of fl sl sr or fr are larger than 0 --> larger than 0 is triggering the bumper*/
        bumperLight();

        /*how long things are being triggered*/
        /*        bumperData += "Front Left: " + flTime + "<br>Side Left: " + slTime + "<br>Front Right: " + frTime + "<br>Side Right:" + srTime;*/

        /*Number of things being triggered*/
        thingToSend += "Front Left: " + fl + "<br>Side Left: " + sl + "<br>Front Right: " + fr + "<br>Side Right:" + sr;

        /*send Stuff*/
        persistantSocket.emit('bumper',thingToSend);

        /*Reset values*/
        thingToSend = [];
        sl=0;
        fl=0;
        fr=0;
        sr=0;
    },

    /*sends graph to website*/
    getGraph: function(LDSScanData,l){
        while(l--){
            posX = LDSScanData[l].DistInMM * Math.sin(LDSScanData[l].AngleInDegrees * PI_180);
            posY = LDSScanData[l].DistInMM * Math.cos(LDSScanData[l].AngleInDegrees * PI_180);
            pos.push({
                y: posY,
                x: -posX
            });
        }
        persistantSocket.emit('graph', pos);
        pos = [];
    },
    /*resets robot*/
    freshRobot: function(){
        port.write('testmode on', function(err) {
            if (err) {return console.log('Error on write: ', err.message);}});
        port.write('\r', function(err) {
            if (err) {return console.log('Error on write: ', err.message);}});
        port.write('setldsrotation off', function(err) {
            if (err) {return console.log('Error on write: ', err.message);}});
        port.write('\r', function(err) {
            if (err) {return console.log('Error on write: ', err.message);}});
    },
}


port.on('data', function (data) {
    /*the daya from the lds comes in single lines. there should be 361 lines from the get lds data command and two from the responses of the other commands that it runs i think..*/
    counter++;
    /*data comes in as (AngleInDegrees,DistInMM,Intensity,Error) I ignore all lines with an error and require a specific distance and angle to save. This saves some time when parsing though the LDSScanData later.*/
    temp = data.split(',');
    if(temp[3] == 0 && temp[1] <= maxDist && temp[1] >= 205){
        if(temp[0]<=50 || temp[0]>=314){
            /*I only save the angle in degrees and the distance in mm because thats all that is useful*/
            LDSScanData.push({
                "AngleInDegrees" : temp[0],
                "DistInMM" : temp[1]
            });
        }
    }

    if(counter == 363){
        l = LDSScanData.length;
        module.exports.getDistanceAndAngles(LDSScanData,maxDist,angle,l,lowestDist);
        //graphs the points. For some reason no matter what robot i use, the data on the right side is off by a bit.
        /* module.exports.getGraph(LDSScanData,l);*/

        /*reset everything back to the base values for next run*/
        LDSScanData = [];
        counter = 0;
        angle = maxAngle;
        lowestDist=maxDist;
    }
});

//when you first open the connection to the port
port.on('open', function() {
    console.log("Robot Online");
    //turn off lds if it was on and set it to test mode
    module.exports.freshRobot();

});

port.on('close', function() {
    console.log("Robot Offline");
});

// open errors will be emitted as an error event
port.on('error', function(err) {
    console.log('Error: ', err.message);
});


io.on('connection', function(socket){
    persistantSocket = socket;
    module.exports.freshRobot();

    if (typeof strip.color != 'undefined')
    {
        strip.color("#00FF00"); // turns entire strip green using a hex colour
        strip.show();
    }


    socket.on('setldsrotation', function(data){
        //run setLDSRotation though the COM port
        module.exports.setLDSRotation();

    });

    socket.on('LDSScan', function(){

        //run getLDSScan though the COM port
        module.exports.getLDSScan();

    });

    console.log("Website connected".green);

    socket.on('disconnect', function() {
        console.log('Website disconnect!'.red);
        port.write('setldsrotation off', function(err) {
            if (err) {return console.log('Error on write: ', err.message);}});
        port.write('\r', function(err) {
            if (err) {return console.log('Error on write: ', err.message);}});
        port.write('testmode off', function(err) {
            if (err) {return console.log('Error on write: ', err.message);}});
        port.write('\r', function(err) {
            if (err) {return console.log('Error on write: ', err.message);}});


        if (typeof strip.color != 'undefined')
        {
            strip.color("#ff0000"); // turns entire strip red using a hex colour
            strip.show();
        }


    });
});

//GO TO localhost:3000 to view the website
server.listen(3000, function(){
    console.log('Neato LDS web controller is now online');
});
