var express=require("express"),http=require("http"),app=express(),server=http.createServer(app),fs=require("fs"),colors=require("colors"),arduinoPort="COM5",five=require("johnny-five"),board=new five.Board({port:"COM5",repl:!1,debug:!1}),counter=0,LDSScanData=[],toggled=0,DistInMM,thingToSend=[],l,pos=[],posX,posY,PI_180=Math.PI/180,io=require("socket.io").listen(server),persistantSocket;app.use(express.static(__dirname+"/html")),app.get("/",function(e,o){o.sendfile("./index.html")});var lowestDist=350,lowestAngle=360,angle=360,maxDist=lowestDist,maxAngle=angle,slTime=0,flTime=0,srTime=0,frTime=0,SerialPort=require("serialport"),port=new SerialPort("COM3",{baudRate:115200,parser:SerialPort.parsers.readline("\n")}),temp=new Array,ledSL,ledFL,ledFR,ledSR;setTimeout(function(){console.log("gimme a sec")},2e3),board.on("ready",function(){console.log("lights ago!!!".rainbow),ledSL=new five.Led(8),ledFL=new five.Led(9),ledFR=new five.Led(10),ledSR=new five.Led(11),ledSL.off(),ledFL.off(),ledFR.off(),ledSR.off()}),module.exports={getLDSScan:function(){port.write("getldsscan",function(e){if(e)return console.log("Error on write: ",e.message)}),port.write("\r",function(e){if(e)return console.log("Error on write: ",e.message)})},setLDSRotation:function(){0==toggled?(port.write("setldsrotation on",function(e){if(e)return console.log("Error on write: ",e.message)}),toggled++):(port.write("setldsrotation off",function(e){if(e)return console.log("Error on write: ",e.message)}),toggled--),port.write("\r",function(e){if(e)return console.log("Error on write: ",e.message)})},getDistanceAndAngles:function(e,o,t,n,r){for(var s=0,i=0,l=0,f=0;n--;)e[n].DistInMM,(t=e[n].AngleInDegrees)>0&&t<=38?s++:t>38&&t<=50?i++:t>=330&&t<360?f++:t>=314&&t<330&&l++;thingToSend+=0!=s||0!=i||0!=l||0!=f?"<h1>Something's out there</h1>":"<h1>Nothing</h1>",0!=i?ledSL.on():0==i&&module.exports.ledSLOff(),0!=s?ledFL.on():0==s&&module.exports.ledFLOff(),0!=f?ledFR.on():0==f&&module.exports.ledFROff(),0!=l?ledSR.on():0==l&&module.exports.ledSROff(),thingToSend+="Front Left: "+s+"<br>Side Left: "+i+"<br>Front Right: "+f+"<br>Side Right:"+l,persistantSocket.emit("bumper",thingToSend),thingToSend=[]},flStart:function(){timerInterval=setInterval(function(){++flTime,console.log(flTime)},1e3)},ledSLOff:function(){ledSL.off()},ledFLOff:function(){ledFL.off()},ledFROff:function(){ledFR.off()},ledSROff:function(){ledSR.off()},getGraph:function(e,o){for(;o--;)posX=e[o].DistInMM*Math.sin(e[o].AngleInDegrees*PI_180),posY=e[o].DistInMM*Math.cos(e[o].AngleInDegrees*PI_180),pos.push({y:posY,x:-posX});persistantSocket.emit("graph",pos),pos=[]},freshRobot:function(){port.write("testmode on",function(e){if(e)return console.log("Error on write: ",e.message)}),port.write("\r",function(e){if(e)return console.log("Error on write: ",e.message)}),port.write("setldsrotation off",function(e){if(e)return console.log("Error on write: ",e.message)}),port.write("\r",function(e){if(e)return console.log("Error on write: ",e.message)})}},port.on("data",function(e){counter++,0==(temp=e.split(","))[3]&&temp[1]<=maxDist&&temp[1]>=205&&(temp[0]<=50||temp[0]>=314)&&LDSScanData.push({AngleInDegrees:temp[0],DistInMM:temp[1]}),363==counter&&(l=LDSScanData.length,module.exports.getDistanceAndAngles(LDSScanData,maxDist,angle,l,lowestDist),LDSScanData=[],counter=0,angle=maxAngle,lowestDist=maxDist)}),port.on("open",function(){console.log("Robot Online"),module.exports.freshRobot()}),port.on("close",function(){console.log("Robot Offline")}),port.on("error",function(e){console.log("Error: ",e.message)}),io.on("connection",function(e){persistantSocket=e,module.exports.freshRobot(),e.on("setldsrotation",function(e){module.exports.setLDSRotation()}),e.on("LDSScan",function(){module.exports.getLDSScan()}),console.log("Website connected".green),e.on("disconnect",function(){console.log("Website disconnect!".red),port.write("setldsrotation off",function(e){if(e)return console.log("Error on write: ",e.message)}),port.write("\r",function(e){if(e)return console.log("Error on write: ",e.message)}),port.write("testmode off",function(e){if(e)return console.log("Error on write: ",e.message)}),port.write("\r",function(e){if(e)return console.log("Error on write: ",e.message)})})}),server.listen(3e3,function(){console.log("Neato LDS web controller is now online")});
